# BlockSuite Yjs ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

> ğŸ“‹ **ë¬¸ì„œ ìƒíƒœ**: ì„¤ê³„ ë° êµ¬í˜„ í˜„í™© ë¬¸ì„œ
> 
> | êµ¬ë¶„ | ìƒíƒœ | ìœ„ì¹˜ |
> |------|------|------|
> | **ë°±ì—”ë“œ API** | âœ… êµ¬í˜„ ì™„ë£Œ | `server/api/blocksuite.go` |
> | **ë°ì´í„° ëª¨ë¸** | âœ… êµ¬í˜„ ì™„ë£Œ | `server/model/blocksuite_doc.go` |
> | **DB ë ˆì´ì–´** | âœ… êµ¬í˜„ ì™„ë£Œ | `server/services/store/sqlstore/blocksuite.go` |
> | **í”„ë¡ íŠ¸ì—”ë“œ** | â³ í…ŒìŠ¤íŠ¸ ì½”ë“œë§Œ ì¡´ì¬ | `public/blocksuite-editor.html` |
> | **BlockSuite ì—ë””í„° í†µí•©** | âŒ ë¯¸êµ¬í˜„ | - |

## ê°œìš”

ì´ ë¬¸ì„œëŠ” ê¸°ì¡´ Focalboard ë¸”ë¡ ì‹œìŠ¤í…œì—ì„œ BlockSuite ê¸°ë°˜ Yjs ë¬¸ì„œ êµ¬ì¡°ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ì´ìœ ì™€ ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## 1. ì™œ Yjsë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•´ì•¼ í•˜ëŠ”ê°€?

### 1.1 BlockSuite ì—ë””í„° í˜¸í™˜ì„±

BlockSuiteëŠ” Notionê³¼ ìœ ì‚¬í•œ ë¸”ë¡ ê¸°ë°˜ ì—ë””í„°ë¡œ, ë‚´ë¶€ì ìœ¼ë¡œ **Yjs**ë¥¼ ë°ì´í„° ë ˆì´ì–´ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
ë”°ë¼ì„œ BlockSuite ì—ë””í„°ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ê¸°ì¡´ ë¸”ë¡ ë°ì´í„°ë¥¼ Yjs í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BlockSuite Architecture                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  UI Layer   â”‚ -> â”‚  Doc Model  â”‚ -> â”‚    Yjs      â”‚      â”‚
â”‚   â”‚  (Editor)   â”‚    â”‚  (Blocks)   â”‚    â”‚  (Storage)  â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ê¸°ì¡´ ë°©ì‹ì˜ í•œê³„

- ê° ë¸”ë¡ì´ ë…ë¦½ì ì¸ DB ë ˆì½”ë“œë¡œ ì €ì¥ë¨
- BlockSuite ì—ë””í„°ê°€ ë‚´ë¶€ì ìœ¼ë¡œ Yjsë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë°ì´í„° ë³€í™˜ í•„ìš”
- ë¸”ë¡ ê°„ ê´€ê³„ì™€ ìˆœì„œ ê´€ë¦¬ê°€ ë³µì¡í•¨

### 1.3 êµ¬í˜„ í˜„í™©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: Yjs ìŠ¤ëƒ…ìƒ· ì €ì¥                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… ë°±ì—”ë“œ API (4ê°œ ì—”ë“œí¬ì¸íŠ¸)                               â”‚
â”‚  âœ… DB í…Œì´ë¸” ë° CRUD (PostgreSQL, MySQL, SQLite)            â”‚
â”‚  âœ… Yjs ë°”ì´ë„ˆë¦¬ ìŠ¤ëƒ…ìƒ· ì €ì¥/ë¡œë“œ                             â”‚
â”‚  â³ í”„ë¡ íŠ¸ì—”ë“œ BlockSuite ì—ë””í„° í†µí•© (ë¯¸êµ¬í˜„)                â”‚
â”‚  â³ ê¸°ì¡´ ë¸”ë¡ â†’ Yjs ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§ (í…ŒìŠ¤íŠ¸ ì½”ë“œì—ë§Œ)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ“ ë°±ì—”ë“œëŠ” ì™„ì „íˆ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. 
> í”„ë¡ íŠ¸ì—”ë“œ í†µí•© ì‹œ `public/blocksuite-editor.html` í…ŒìŠ¤íŠ¸ ì½”ë“œì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§ì„ ì°¸ê³ í•˜ì„¸ìš”.

### 1.4 í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„± (Phase 2)

YjsëŠ” CRDT(Conflict-free Replicated Data Type) ê¸°ë°˜ì´ë¯€ë¡œ, í–¥í›„ ì‹¤ì‹œê°„ í˜‘ì—… ê¸°ëŠ¥ ì¶”ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 2: ì‹¤ì‹œê°„ í˜‘ì—… (í–¥í›„)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ìë™ ì¶©ëŒ í•´ê²°: ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— í¸ì§‘í•´ë„ ìë™ ë³‘í•©    â”‚
â”‚  â€¢ ì˜¤í”„ë¼ì¸ ì§€ì›: ì˜¤í”„ë¼ì¸ì—ì„œ í¸ì§‘ í›„ ì˜¨ë¼ì¸ ì‹œ ìë™ ë™ê¸°í™”  â”‚
â”‚  â€¢ íˆìŠ¤í† ë¦¬ ê´€ë¦¬: ë³€ê²½ ì´ë ¥ ì¶”ì  ë° ì–¸ë‘/ë¦¬ë‘ ì§€ì›           â”‚
â”‚  â€¢ íš¨ìœ¨ì  ë™ê¸°í™”: ë³€ê²½ëœ ë¶€ë¶„ë§Œ ì „ì†¡ (delta sync)            â”‚
â”‚  â†’ WebSocket ê¸°ë°˜ y-websocket ì—°ë™ í•„ìš”                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ë°ì´í„° êµ¬ì¡°

### 2.1 ê¸°ì¡´ ë¸”ë¡ êµ¬ì¡° (DB ë ˆì½”ë“œ)

```json
{
  "id": "block-123",
  "type": "text",
  "title": "Hello World",
  "parentId": "card-456",
  "fields": {
    "value": false
  }
}
```

### 2.2 BlockSuite Yjs êµ¬ì¡°

```javascript
Y.Doc {
  blocks: Y.Map {
    "block-123": Y.Map {
      id: "block-123",
      type: "affine:paragraph",
      props: { type: "text" },
      text: "Hello World"
    }
  },
  meta: Y.Map {
    blockOrder: ["block-123", ...],
    cardId: "card-456",
    cardTitle: "Card Title"
  }
}
```

### 2.3 ë¸”ë¡ íƒ€ì… ë§¤í•‘

ê¸°ì¡´ Focalboard ë¸”ë¡ íƒ€ì…ì´ BlockSuite íƒ€ì…ìœ¼ë¡œ ì–´ë–»ê²Œ ë³€í™˜ë˜ëŠ”ì§€:

| ê¸°ì¡´ íƒ€ì… | BlockSuite íƒ€ì… | props |
|-----------|-----------------|-------|
| `text` | `affine:paragraph` | `{ type: "text" }` |
| `h1` | `affine:paragraph` | `{ type: "h1" }` |
| `h2` | `affine:paragraph` | `{ type: "h2" }` |
| `h3` | `affine:paragraph` | `{ type: "h3" }` |
| `checkbox` | `affine:list` | `{ type: "todo", checked: boolean }` |
| `list` | `affine:list` | `{ type: "bulleted" }` |
| `numbered-list` | `affine:list` | `{ type: "numbered" }` |
| `quote` | `affine:paragraph` | `{ type: "quote" }` |
| `divider` | `affine:divider` | `{}` |
| `image` | `affine:image` | `{ sourceId, filename, width, height }` |
| `video` | `affine:embed` | `{ type: "video", sourceId, filename }` |
| `attachment` | `affine:attachment` | `{ sourceId, filename, size }` |

---

## 3. ë§ˆì´ê·¸ë ˆì´ì…˜ íë¦„

### 3.1 Smart Load í”Œë¡œìš°

ì‚¬ìš©ìê°€ ì¹´ë“œ ì—ë””í„°ë¥¼ ì—´ ë•Œ, BlockSuite ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë™ì‘í•©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Smart Load Flow                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚   â”‚  Start      â”‚                                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚          â–¼                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚   â”‚ GET /blocksuite/info â”‚  BlockSuite ë¬¸ì„œ ì¡´ì¬ í™•ì¸            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚              â”‚                                                   â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚      â–¼               â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ 200 OK â”‚    â”‚ 404     â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â”‚
â”‚      â”‚              â”‚                                            â”‚
â”‚      â–¼              â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ Load Yjs   â”‚  â”‚ Fetch Legacy Blocksâ”‚                         â”‚
â”‚  â”‚ Document   â”‚  â”‚ (GET /blocks)      â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚        â”‚                   â”‚                                     â”‚
â”‚        â”‚                   â–¼                                     â”‚
â”‚        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚        â”‚         â”‚ Convert to Yjs     â”‚                         â”‚
â”‚        â”‚         â”‚ BlockSuite Format  â”‚                         â”‚
â”‚        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚        â”‚                   â”‚                                     â”‚
â”‚        â”‚                   â–¼                                     â”‚
â”‚        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚        â”‚         â”‚ Auto-save to Serverâ”‚                         â”‚
â”‚        â”‚         â”‚ (PUT /content)     â”‚                         â”‚
â”‚        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚        â”‚                   â”‚                                     â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                    â–¼                                             â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚            â”‚ Editor Ready â”‚                                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ì‹œë‚˜ë¦¬ì˜¤ë³„ ë™ì‘

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì²« ì ‘ê·¼ (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)

```
1. ì‚¬ìš©ìê°€ ì¹´ë“œ ì—ë””í„° ì—´ê¸°
2. GET /blocksuite/info â†’ 404 (ë¬¸ì„œ ì—†ìŒ)
3. GET /blocks â†’ ê¸°ì¡´ ë¸”ë¡ë“¤ ì¡°íšŒ
4. convertLegacyBlocksToYjs() â†’ Yjs ë¬¸ì„œ ìƒì„±
5. PUT /blocksuite/content â†’ ë³€í™˜ëœ ë¬¸ì„œ ì €ì¥
6. ì—ë””í„°ì—ì„œ í¸ì§‘ ì‹œì‘
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ì¬ì ‘ê·¼ (ì´ë¯¸ ë§ˆì´ê·¸ë ˆì´ì…˜ë¨)

```
1. ì‚¬ìš©ìê°€ ì¹´ë“œ ì—ë””í„° ì—´ê¸°
2. GET /blocksuite/info â†’ 200 OK
3. GET /blocksuite/content â†’ Yjs ìŠ¤ëƒ…ìƒ· ë¡œë“œ
4. Y.applyUpdate(yDoc, snapshot) â†’ ë¬¸ì„œ ë³µì›
5. ì—ë””í„°ì—ì„œ í¸ì§‘ ì‹œì‘
```

---

## 4. API ì—”ë“œí¬ì¸íŠ¸

### 4.1 BlockSuite ë¬¸ì„œ API (âœ… êµ¬í˜„ ì™„ë£Œ)

> ğŸ“ êµ¬í˜„ ìœ„ì¹˜: `server/api/blocksuite.go`

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| `GET` | `/cards/{cardID}/blocksuite/content` | Yjs ë°”ì´ë„ˆë¦¬ ìŠ¤ëƒ…ìƒ· ë¡œë“œ |
| `PUT` | `/cards/{cardID}/blocksuite/content` | Yjs ë°”ì´ë„ˆë¦¬ ìŠ¤ëƒ…ìƒ· ì €ì¥ |
| `GET` | `/cards/{cardID}/blocksuite/info` | ë¬¸ì„œ ë©”íƒ€ë°ì´í„° ì¡°íšŒ |
| `DELETE` | `/cards/{cardID}/blocksuite` | ë¬¸ì„œ ì‚­ì œ |

### 4.2 ê¸°ì¡´ ë¸”ë¡ API (ë ˆê±°ì‹œ)

> ğŸ“ êµ¬í˜„ ìœ„ì¹˜: `server/api/blocks.go`
> 
> ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ê¸°ì¡´ ë¸”ë¡ì„ ì¡°íšŒí•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| `GET` | `/boards/{boardID}/blocks?parent_id={cardID}` | ì¹´ë“œì˜ í•˜ìœ„ ë¸”ë¡ ì¡°íšŒ |
| `POST` | `/boards/{boardID}/blocks` | ë¸”ë¡ ìƒì„± |
| `PATCH` | `/boards/{boardID}/blocks/{blockID}` | ë¸”ë¡ ìˆ˜ì • |
| `DELETE` | `/boards/{boardID}/blocks/{blockID}` | ë¸”ë¡ ì‚­ì œ |

### 4.3 ì €ì¥ í˜•ì‹

```
Content-Type: application/octet-stream

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Yjs Binary Snapshot                    â”‚
â”‚  (Y.encodeStateAsUpdate(yDoc))         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ì••ì¶•ëœ ë°”ì´ë„ˆë¦¬ í˜•ì‹                  â”‚
â”‚  â€¢ ì „ì²´ ë¬¸ì„œ ìƒíƒœ í¬í•¨                   â”‚
â”‚  â€¢ ì¦ë¶„ ì—…ë°ì´íŠ¸ ì§€ì› ê°€ëŠ¥               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ì´ë¯¸ì§€/íŒŒì¼ ì²˜ë¦¬

### 5.1 ê¸°ì¡´ íŒŒì¼ API ì¬ì‚¬ìš©

ì´ë¯¸ì§€, ë¹„ë””ì˜¤, ì²¨ë¶€íŒŒì¼ì€ **ê¸°ì¡´ Focalboard íŒŒì¼ APIë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©**í•©ë‹ˆë‹¤.
Yjs ë¬¸ì„œì—ëŠ” íŒŒì¼ ë©”íƒ€ë°ì´í„°(fileId, filename ë“±)ë§Œ ì €ì¥í•˜ê³ , ì‹¤ì œ íŒŒì¼ì€ ê¸°ì¡´ ì €ì¥ì†Œì— ìœ ì§€ë©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  íŒŒì¼ ì €ì¥ êµ¬ì¡°                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   [ê¸°ì¡´ Block]                   [Yjs Document]                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ type: image â”‚               â”‚ type:       â”‚                 â”‚
â”‚   â”‚ fields: {   â”‚      â†’        â”‚  affine:    â”‚                 â”‚
â”‚   â”‚   fileId    â”‚   ë§¤í•‘        â”‚  image      â”‚                 â”‚
â”‚   â”‚   filename  â”‚               â”‚ props: {    â”‚                 â”‚
â”‚   â”‚   width     â”‚               â”‚   sourceId  â”‚  â† fileId       â”‚
â”‚   â”‚ }           â”‚               â”‚   filename  â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ }           â”‚                 â”‚
â”‚         â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                              â”‚                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                    â–¼                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   â”‚  ê¸°ì¡´ íŒŒì¼ ì €ì¥ì†Œ (ë³€ê²½ ì—†ìŒ)        â”‚                        â”‚
â”‚   â”‚  /files/teams/{teamID}/{boardID}/  â”‚                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 íŒŒì¼ API ì—”ë“œí¬ì¸íŠ¸

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| `POST` | `/teams/{teamID}/{boardID}/files` | íŒŒì¼ ì—…ë¡œë“œ (multipart/form-data) |
| `GET` | `/files/teams/{teamID}/{boardID}/{fileId}` | íŒŒì¼ ë‹¤ìš´ë¡œë“œ |
| `GET` | `/files/teams/{teamID}/{boardID}/{fileId}/info` | íŒŒì¼ ë©”íƒ€ì •ë³´ ì¡°íšŒ |

### 5.3 ì´ë¯¸ì§€ ë¸”ë¡ ë³€í™˜ ì˜ˆì‹œ

```javascript
// ê¸°ì¡´ image ë¸”ë¡
{
  "type": "image",
  "fields": {
    "fileId": "7abc123def456.png",
    "filename": "screenshot.png",
    "width": 800,
    "height": 600
  }
}

// â†’ BlockSuite Yjs í˜•ì‹ìœ¼ë¡œ ë³€í™˜
{
  "type": "affine:image",
  "originalType": "image",
  "props": {
    "sourceId": "7abc123def456.png",  // fileId â†’ sourceId
    "filename": "screenshot.png",
    "width": 800,
    "height": 600
  }
}
```

### 5.4 ì´ë¯¸ì§€ ë¡œë“œ ì‹œ URL ìƒì„±

```javascript
// Previewì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ
const imageUrl = `${apiBase}/files/teams/${teamId}/${boardId}/${sourceId}`;

// fetchë¡œ ì´ë¯¸ì§€ ë¡œë“œ (ì¸ì¦ í¬í•¨)
const response = await fetch(imageUrl, {
    credentials: 'include',
    headers: getApiHeaders(),
});
const blob = await response.blob();
const blobUrl = URL.createObjectURL(blob);
```

### 5.5 ì™œ ì´ë¯¸ì§€ë¥¼ Yjsì— ì§ì ‘ ì €ì¥í•˜ì§€ ì•ŠëŠ”ê°€?

| ì´ìœ  | ì„¤ëª… |
|------|------|
| íŒŒì¼ í¬ê¸° | ì´ë¯¸ì§€ë¥¼ Yjsì— ì €ì¥í•˜ë©´ ë¬¸ì„œ í¬ê¸°ê°€ ê¸‰ê²©íˆ ì¦ê°€ |
| ë™ê¸°í™” íš¨ìœ¨ | CRDT ë™ê¸°í™” ì‹œ í° ë°”ì´ë„ˆë¦¬ ì „ì†¡ì€ ë¹„íš¨ìœ¨ì  |
| ê¸°ì¡´ ì¸í”„ë¼ | Mattermost íŒŒì¼ ì €ì¥ì†Œ/CDN ì¬ì‚¬ìš© ê°€ëŠ¥ |
| ê¶Œí•œ ê´€ë¦¬ | ê¸°ì¡´ ë³´ë“œ ê¶Œí•œìœ¼ë¡œ íŒŒì¼ ì ‘ê·¼ ì œì–´ |
| ì¤‘ë³µ ë°©ì§€ | ê°™ì€ íŒŒì¼ì„ ì—¬ëŸ¬ ë¬¸ì„œì—ì„œ ì°¸ì¡° ê°€ëŠ¥ |

### 5.6 í…ìŠ¤íŠ¸ í¸ì§‘ ì‹œ ì´ë¯¸ì§€ ë¸”ë¡ ë³´ì¡´

í˜„ì¬ textarea ê¸°ë°˜ ì—ë””í„°ì—ì„œëŠ” í…ìŠ¤íŠ¸ í¸ì§‘ ì‹œ ì´ë¯¸ì§€ ë¸”ë¡ì´ ìœ ì‹¤ë  ìˆ˜ ìˆì–´ ë³´ì¡´ ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤:

```javascript
// 1. ë¬¸ì„œ ë¡œë“œ ì‹œ ì´ë¯¸ì§€ ë¸”ë¡ì„ ì „ì—­ ì €ì¥ì†Œì— ë³´ì¡´
let preservedImageBlocks = new Map();

function saveImageBlocksToGlobal() {
    const yBlocks = yDoc.getMap('blocks');
    yBlocks.forEach((yBlock, blockId) => {
        const type = yBlock.get('type');
        if (type === 'affine:image' || 
            type === 'affine:embed' || 
            type === 'affine:attachment') {
            preservedImageBlocks.set(blockId, cloneBlock(yBlock));
        }
    });
}

// 2. í…ìŠ¤íŠ¸ì—ì„œëŠ” í”Œë ˆì´ìŠ¤í™€ë”ë¡œ í‘œì‹œ
// "[Image: screenshot.png]"
// "[Video: demo.mp4]"
// "[Attachment: document.pdf]"

// 3. ì €ì¥ ì‹œ í”Œë ˆì´ìŠ¤í™€ë”ì™€ ë³´ì¡´ëœ ë¸”ë¡ ë§¤ì¹­í•˜ì—¬ ë³µì›
```

> **ì°¸ê³ **: ì‹¤ì œ BlockSuite ì—ë””í„° ì‚¬ìš© ì‹œì—ëŠ” ì´ ë³´ì¡´ ë¡œì§ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
> í˜„ì¬ëŠ” textarea ê¸°ë°˜ í…ŒìŠ¤íŠ¸ ì—ë””í„°ì´ê¸° ë•Œë¬¸ì— í•„ìš”í•œ ì„ì‹œ ë¡œì§ì…ë‹ˆë‹¤.

---

## 6. í•µì‹¬ í•¨ìˆ˜ ì„¤ëª…

### 6.1 `convertLegacyBlocksToYjs(blocks, card, ydoc)`

ê¸°ì¡´ ë¸”ë¡ ë°°ì—´ì„ Yjs ë¬¸ì„œë¡œ ë³€í™˜í•©ë‹ˆë‹¤:

```javascript
function convertLegacyBlocksToYjs(blocks, card, ydoc) {
    const yBlocks = ydoc.getMap('blocks');  // ë¸”ë¡ ì €ì¥ì†Œ
    const yMeta = ydoc.getMap('meta');      // ë©”íƒ€ë°ì´í„°

    // contentOrderì— ë”°ë¼ ë¸”ë¡ ì •ë ¬
    const contentOrder = card.fields?.contentOrder || [];
    const sortedBlocks = [...blocks].sort((a, b) => {
        const aIndex = contentOrder.indexOf(a.id);
        const bIndex = contentOrder.indexOf(b.id);
        if (aIndex === -1 && bIndex === -1) return 0;
        if (aIndex === -1) return 1;
        if (bIndex === -1) return -1;
        return aIndex - bIndex;
    });

    // ë©”íƒ€ë°ì´í„° ì €ì¥
    yMeta.set('blockOrder', sortedBlocks.map(b => b.id));
    yMeta.set('cardId', card.id);
    yMeta.set('cardTitle', card.title || '');

    // ê° ë¸”ë¡ì„ Yjs Mapìœ¼ë¡œ ë³€í™˜
    sortedBlocks.forEach(block => {
        const yBlock = new Y.Map();
        const converted = convertBlockToYjs(block);
        Object.entries(converted).forEach(([key, value]) => {
            yBlock.set(key, value);
        });
        yBlocks.set(block.id, yBlock);
    });
}
```

### 6.2 `convertBlockToYjs(block)`

ë‹¨ì¼ ë¸”ë¡ì„ BlockSuite í˜¸í™˜ í˜•ì‹ìœ¼ë¡œ ë³€í™˜:

```javascript
function convertBlockToYjs(block) {
    const type = block.type;
    const result = {
        id: block.id,
        originalType: type,  // ì›ë³¸ íƒ€ì… ë³´ì¡´ (ì—­ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ëŠ¥)
        createdAt: block.createAt || Date.now(),
        updatedAt: block.updateAt || Date.now(),
    };

    switch (type) {
        case 'text':
            result.type = 'affine:paragraph';
            result.props = { type: 'text' };
            result.text = block.title;
            break;
        case 'checkbox':
            result.type = 'affine:list';
            result.props = { 
                type: 'todo',
                checked: block.fields?.value || false 
            };
            result.text = block.title;
            break;
        case 'image':
            result.type = 'affine:image';
            result.props = {
                sourceId: block.fields?.fileId || '',
                filename: block.fields?.filename || 'image',
                width: block.fields?.width || 0,
                height: block.fields?.height || 0,
            };
            break;
        // ... ê¸°íƒ€ íƒ€ì…ë“¤
    }
    return result;
}
```

---

## 7. ì£¼ì˜ì‚¬í•­

### 7.1 ì›ë³¸ ë°ì´í„° ë³´ì¡´ (ì„¤ê³„ ì œì•ˆ)

- Yjs ë¬¸ì„œ ë‚´ë¶€ì— `originalType` í•„ë“œë¡œ ê¸°ì¡´ ë¸”ë¡ íƒ€ì…ì„ ì €ì¥ (í”„ë¡ íŠ¸ì—”ë“œ ë¡œì§)
- ë°±ì—”ë“œëŠ” Yjs ë°”ì´ë„ˆë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ë¯€ë¡œ ì´ í•„ë“œë¥¼ ì¸ì‹í•˜ì§€ ì•ŠìŒ
- í•„ìš”ì‹œ ì—­ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„

> âš ï¸ ì´ í•„ë“œëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ(`public/blocksuite-editor.html`)ì—ë§Œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
> í”„ë¡ íŠ¸ì—”ë“œ í†µí•© ì‹œ êµ¬í˜„ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ì„¸ìš”.

### 7.2 ë¸”ë¡ ìˆœì„œ ìœ ì§€

- `card.fields.contentOrder` ë°°ì—´ ì°¸ì¡°
- `yMeta.blockOrder`ì— ìˆœì„œ ì €ì¥

### 7.3 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì 

- ì‚¬ìš©ìê°€ ì—ë””í„°ë¥¼ ì—´ ë•Œ ìë™ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ (Lazy Migration)
- ì„œë²„ì—ì„œ ì¼ê´„ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ì§€ ì•ŠìŒ

---

## 8. ê²°ë¡ 

### Phase 1 í˜„í™©

| êµ¬ë¶„ | ìƒíƒœ | ì„¤ëª… |
|------|------|------|
| ë°±ì—”ë“œ API | âœ… ì™„ë£Œ | 4ê°œ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ (`server/api/blocksuite.go`) |
| DB ë ˆì´ì–´ | âœ… ì™„ë£Œ | PostgreSQL, MySQL, SQLite ì§€ì› |
| ë°ì´í„° ëª¨ë¸ | âœ… ì™„ë£Œ | `BlockSuiteDoc`, `BlockSuiteDocInfo` |
| í”„ë¡ íŠ¸ì—”ë“œ í†µí•© | â³ ë¯¸ì™„ë£Œ | BlockSuite ì—ë””í„° ì—°ë™ í•„ìš” |
| ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§ | â³ í…ŒìŠ¤íŠ¸ë§Œ | í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ê²€ì¦ë¨ |

> **ë‹¤ìŒ ë‹¨ê³„**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ BlockSuite ì—ë””í„°ë¥¼ í†µí•©í•˜ê³ , 
> `public/blocksuite-editor.html`ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§ì„ ì°¸ê³ í•˜ì—¬ Smart Load ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë©´ ë©ë‹ˆë‹¤.

### Phase 2 (í–¥í›„ í™•ì¥)

â³ **ì‹¤ì‹œê°„ í˜‘ì—…** - WebSocket + y-websocketìœ¼ë¡œ CRDT ë™ê¸°í™”
â³ **ì˜¤í”„ë¼ì¸ ì§€ì›** - y-indexeddbë¡œ ë¡œì»¬ ì €ì¥ í›„ ë™ê¸°í™”
â³ **ì¶©ëŒ í•´ê²°** - CRDT ê¸°ë°˜ ìë™ ì¶©ëŒ í•´ê²°
â³ **Awareness** - ë‹¤ë¥¸ ì‚¬ìš©ì ì»¤ì„œ ìœ„ì¹˜ í‘œì‹œ

Phase 2 êµ¬í˜„ì„ ìœ„í•´ì„œëŠ” ë°±ì—”ë“œì— WebSocket ì—”ë“œí¬ì¸íŠ¸ì™€ Yjs ì—…ë°ì´íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŒ… ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.

---

## ë¶€ë¡: ë°±ì—”ë“œ êµ¬í˜„ íŒŒì¼

| íŒŒì¼ | ì„¤ëª… |
|------|------|
| `server/api/blocksuite.go` | API í•¸ë“¤ëŸ¬ (4ê°œ ì—”ë“œí¬ì¸íŠ¸) |
| `server/app/blocksuite.go` | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ |
| `server/model/blocksuite_doc.go` | ë°ì´í„° ëª¨ë¸ ì •ì˜ |
| `server/services/store/sqlstore/blocksuite.go` | DB CRUD |
| `server/api/blocks.go` | ê¸°ì¡´ ë¸”ë¡ API (ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ì¡°íšŒìš©) |
| `server/api/files.go` | íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ API |
